name: Deploy

on:
  push:
    branches:
      - main
      - feat/serveractions

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 'Prepare deploy key'
        run: |
          echo "${{secrets.SSH_KEY}}" > deploy_key
          chmod 600 ./deploy_key

      - name: 'Remote server commands'
        uses: 'nick-fields/retry@v2'
        with:
          timeout_minutes: 1
          max_attempts: 5
          retry_wait_seconds: 1
          retry_on: 'error'
          command: |
            ssh -T -i ./deploy_key -p 22 waffle@${{ secrets.SSH_HOST }}
            cd ~/csereal_web
            npm run build
            pm2 stop csereal_front
            pm2 --name csereal_front start npm -- start
