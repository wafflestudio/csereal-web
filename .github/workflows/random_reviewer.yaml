name: 'Random reviewer'

on:
  pull_request:
    types:
      - opened
    branches:
      - '**'
  workflow_dispatch:

jobs:
  random-reviwer:
    runs-on: ubuntu-latest
    steps:
      - id: random_reviewer
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const myId  = '${{ github.event.pull_request.user.login }}';
            const idList = ['yeolyi', 'Limchansol', 'goranikin', 'onemeee'];
            const candidateList = idList.filter(id => id !== myId);

            const recentPRs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              sort: 'updated',
              direction: 'desc',
              per_page: 10
            });

            const reviewCounts = {};
            candidateList.forEach(reviewer => {
              reviewCounts[reviewer] = 0;
            });

            for (const pr of recentPRs.data) {
              const reviewers = await github.rest.pulls.listRequestedReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number
              });
              for (const reviewer of reviewers.data.users) {
                if (reviewCounts[reviewer.login] !== undefined) {
                  reviewCounts[reviewer.login]++;
                }
              }
            }

            console.log('(ë””ë²„ê¹…ìš©) Reviewer counts:', reviewCounts);

            const minCount = Math.min(...Object.values(reviewCounts));
            const leastAssignedReviewers = Object.keys(reviewCounts).filter(
              reviewer => reviewCounts[reviewer] === minCount
            );
            const randomReviewer = leastAssignedReviewers[
              Math.floor(Math.random() * leastAssignedReviewers.length)
            ];

            const deadline = new Date(Date.now() + 3 * 24 * 60 * 60 * 1000);
            const comment = `@${randomReviewer}ë‹˜ ${deadline.toLocaleDateString('ko-KR')}ê¹Œì§€ ë¦¬ë·° ë¶€íƒë“œë¦½ë‹ˆë‹¤ ğŸ‰`

            core.setOutput('comment', comment)
            core.setOutput('reviewer', randomReviewer)
      - name: comment PR
        uses: mshick/add-pr-comment@v1
        with:
          message: |
            ${{ steps.random_reviwer.outputs.comment }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          repo-token-user-login: 'github-actions[bot]'

      - name: Add Pull Request Reviewer
        uses: madrapps/add-reviewers@v1
        with:
          reviewers: ${{ steps.random_reviwer.outputs.reviewer }}
          token: ${{ secrets.GITHUB_TOKEN }}
